<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Assessment Results</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50">

    <main class="container mx-auto px-4 py-12 max-w-3xl">
        <div class="bg-white p-8 rounded-xl shadow-lg">
            
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">
                Your Health Assessment Results
            </h1>

            <!-- RESULT SCORES -->
            <div class="space-y-6">
                
                <!-- Malaria -->
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="font-semibold text-gray-700">Malaria Risk</span>
                        <span id="malaria-score" class="font-bold text-blue-600">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 h-3 rounded">
                        <div id="malaria-bar" class="bg-blue-600 h-3 rounded" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Diabetes -->
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="font-semibold text-gray-700">Diabetes Risk</span>
                        <span id="diabetes-score" class="font-bold text-purple-600">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 h-3 rounded">
                        <div id="diabetes-bar" class="bg-purple-600 h-3 rounded" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Respiratory -->
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="font-semibold text-gray-700">Respiratory Infection Risk</span>
                        <span id="respiratory-score" class="font-bold text-green-600">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 h-3 rounded">
                        <div id="respiratory-bar" class="bg-green-600 h-3 rounded" style="width: 0%"></div>
                    </div>
                </div>

            </div>

            <!-- Explanation -->
            <div class="bg-blue-50 p-4 rounded mt-6">
                <h3 class="font-semibold mb-2 text-blue-700">Summary</h3>
                <p id="explanation" class="text-gray-700">
                    Loading analysis...
                </p>
            </div>

            <p class="text-sm text-gray-500 mt-2 text-right">
                Generated on: <span id="result-date"></span>
            </p>

            <!-- Doctor Reply Box -->
            <div id="doctor-reply-box" class="hidden mt-6 p-4 bg-green-50 border border-green-300 rounded">
                <h3 class="font-semibold text-green-700">Doctorâ€™s Response</h3>
                <p id="doctor-reply-text" class="text-gray-800 mt-2"></p>
            </div>

            <!-- Consult a Doctor Button -->
            <button 
                onclick="openDoctorModal()"
                class="w-full mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition">
                Consult a Doctor
            </button>

            <!-- Buttons -->
            <div class="flex justify-between mt-8">
                <button 
                    onclick="window.location.href='index.html'"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded">
                    Take Assessment Again
                </button>

                <button 
                    onclick="downloadResults()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                    Download Results
                </button>
            </div>
        </div>
    </main>

    <!-- Modal -->
    <div id="doctor-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Send Message to Doctor</h2>

            <textarea id="doctor-message-input"
                class="w-full border border-gray-300 rounded p-3 h-32"
                placeholder="Describe your concern... (No personal details needed)"></textarea>

            <div class="flex justify-end gap-3 mt-4">
                <button onclick="closeDoctorModal()" class="px-4 py-2 bg-gray-300 rounded">
                    Cancel
                </button>
                <button onclick="sendMessageToDoctor()" 
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">
                    Send
                </button>
            </div>
        </div>
    </div>

<script>
/* =======================
      LOAD RESULTS
=========================*/
const result = JSON.parse(sessionStorage.getItem("healthAssessment"));

if (!result) {
    window.location.href = "index.html";
}

document.getElementById("result-date").textContent = new Date().toLocaleDateString();

// Format %
const malaria = Math.round(result.risk_scores.malaria * 100);
const diabetes = Math.round(result.risk_scores.diabetes * 100);
const resp = Math.round(result.risk_scores.respiratory_infection * 100);

// Update UI
document.getElementById("malaria-score").textContent = malaria + "%";
document.getElementById("malaria-bar").style.width = malaria + "%";

document.getElementById("diabetes-score").textContent = diabetes + "%";
document.getElementById("diabetes-bar").style.width = diabetes + "%";

document.getElementById("respiratory-score").textContent = resp + "%";
document.getElementById("respiratory-bar").style.width = resp + "%";

document.getElementById("explanation").textContent = result.explanation;

/* =========================
   CHECK FOR DOCTOR REPLY
===========================*/
fetch("consultations.json")
  .then((res) => res.json())
  .then((data) => {
      const entry = data.messages.find(
        (m) => JSON.stringify(m.assessment) === JSON.stringify(result)
      );

      if (entry && entry.doctor_reply) {
          document.getElementById("doctor-reply-box").classList.remove("hidden");
          document.getElementById("doctor-reply-text").textContent = entry.doctor_reply;
      }
  })
  .catch((err) => console.error("Error loading doctor reply:", err));

/* =========================
   CONSULT A DOCTOR MODAL
===========================*/
function openDoctorModal() {
    document.getElementById("doctor-modal").classList.remove("hidden");
}

function closeDoctorModal() {
    document.getElementById("doctor-modal").classList.add("hidden");
}

/* =========================
  SEND MESSAGE TO DOCTOR
===========================*/
function sendMessageToDoctor() {
    const message = document.getElementById("doctor-message-input").value.trim();
    if (!message) return alert("Please type your message");

    fetch("/api/sendToDoctor", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            message,
            assessment: result
        })
    })
    .then(() => {
        alert("Message sent to doctor. You will receive a response soon.");
        closeDoctorModal();
    })
    .catch(err => {
        alert("Error sending message.");
        console.error(err);
    });
}

/* =========================
   DOWNLOAD RESULTS
===========================*/
function downloadResults() {
    const text = `
Health Assessment Results
-------------------------
Malaria Risk: ${malaria}%
Diabetes Risk: ${diabetes}%
Respiratory Infection Risk: ${resp}%

Summary:
${result.explanation}

Generated on: ${new Date().toLocaleDateString()}
    `.trim();

    const blob = new Blob([text], { type: "text/plain" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "health_results.txt";
    link.click();
}
</script>

</body>
</html>
